<!DOCTYPE html>
<html lang="es">
<head>
 <meta charset="UTF-8" />
 <meta name="viewport" content="width=device-width, initial-scale=1.0" />
 <link rel="stylesheet" href="css/style.css">
 <link rel="stylesheet" href="css/forms.css">
 <title>Formulario de Solicitud ‚Ä¢ PaperEase</title>
</head>
<body>
<!-- Header -->
 <header>
 <div class="container">
 <div class="logo-container">
 <img src="imagenes/logo.png" alt="PaperEase Logo" class="logo" />
 <span class="logo-text">PaperEase</span>

 </header>

<!-- Contenido principal -->
 <main>
 <section class="form-section">
 <div class="container">
 <h2>Formulario de Solicitud</h2>
 <p>Completa los campos con tus datos personales y elige el programa de Bienestar Estudiantil que deseas solicitar.</p>

<form id="formulario" method="POST" enctype="multipart/form-data" class="formulario">
  
  <!-- ‚≠ê Campo de c√©dula OCULTO - se llena autom√°ticamente desde la sesi√≥n -->
  <input type="hidden" id="cedula" name="cedula" />
  
  <div class="form-group">
    <label for="nombre">Nombre</label>
    <input type="text" id="nombre" name="nombre" required />
  </div>
  
  <div class="form-group">
    <label for="apellido">Apellido</label>
    <input type="text" id="apellido" name="apellido" required />
  </div>
  
  <div class="form-group genero-radio-group">
    <label>G√©nero</label>
    <div class="form-radio-group">
      <label class="form-radio">
        <input type="radio" name="genero" value="1" required />
        Masculino
      </label>
      <label class="form-radio">
        <input type="radio" name="genero" value="2" />
        Femenino
      </label>
    </div>
  </div>
  
  <div class="form-group">
    <label for="facultad">Facultad</label>
    <select id="facultad" name="facultad" required>
      <option value="">Seleccione una facultad</option>
      <option value="1">Civil</option>
      <option value="5">CyT</option>
      <option value="6">El√©ctrica</option>
      <option value="2">Industrial</option>
      <option value="3">Mec√°nica</option>
      <option value="4">Sistema</option>
    </select>
  </div>

  <div class="form-group">
    <label for="tipoPrograma">Tipo de Programa</label>
    <select id="tipoPrograma" name="tipoPrograma" required>
      <option value="">Seleccione un tipo</option>
      <option value="1">Promoci√≥n Social</option>
      <option value="2">Salud</option>
    </select>
  </div>
  
  <div class="form-group">
    <label for="programa">Programa a Solicitar</label>
    <select id="programa" name="programa" required>
      <option value="">Seleccione una opci√≥n</option>
      <optgroup label="Promoci√≥n Social">
        <option value="1" data-tipo="1">Canasta Navide√±a</option>
        <option value="2" data-tipo="1">Campa√±a de Fortalecimiento de Valores</option>
        <option value="3" data-tipo="1">Campa√±a de Concienciaci√≥n de Instalaciones</option>
        <option value="4" data-tipo="1">Feria de Empleo</option>
        <option value="5" data-tipo="1">Consejer√≠a Personal</option>
      </optgroup>
      <optgroup label="Salud">
        <option value="6" data-tipo="2">Banco de Sangre</option>
        <option value="7" data-tipo="2">Ayuda en Gastos M√©dicos</option>
        <option value="8" data-tipo="2">Feria de Salud</option>
        <option value="9" data-tipo="2">Compra de Lentes</option>
        <option value="10" data-tipo="2">Apoyo en medicamentos</option>
        <option value="11" data-tipo="2">P√≥liza de Salud</option>
      </optgroup>
    </select>
  </div>
  
  <div class="form-group">
    <label for="archivo">Adjuntar Archivos (PDF, JPG, PNG)</label>
    <input type="file" id="archivo" name="archivo" accept=".pdf,.jpg,.jpeg,.png" />
  </div>
  
  <div class="cta-section">
     <button type="submit" class="cta-primary">Enviar Solicitud</button>
     <button type="button" onclick="window.location.href='Programas.html'" class="cta-secondary">Cancelar</button>
  </div>
 
</form>

<!-- Mensajes de estado -->
<div id="message" style="display: none; padding: 15px; margin: 20px 0; border-radius: 5px;"></div>
<div id="loading" style="display: none; text-align: center; padding: 20px;"></div>
 </div>
 </section>
 </main>

<!-- Footer -->
 <footer>
 <div class="footer-flex container">
 <p>¬© 2025 PaperEase ‚Ä¢ Universidad Tecnol√≥gica de Panam√°</p>
 <div class="footer-links">
 <a href="#">Ayuda</a>
 <a href="#">Privacidad</a>
 <a href="#">T√©rminos</a>
 </div>
 </div>
 </footer>

<script src="js/authHelper.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('.formulario');
    const messageDiv = document.getElementById('message');
    const loadingDiv = document.getElementById('loading');

    // ‚≠ê‚≠ê‚≠ê OBTENER LOS DATOS DEL USUARIO DESDE EL NUEVO ENDPOINT ‚≠ê‚≠ê‚≠ê
    async function cargarDatosSesion() {
        try {
            console.log('üîç Obteniendo datos del usuario autenticado...');

            // Obtener el token de autenticaci√≥n
            const token = getAuthToken();

            if (!token) {
                console.warn('‚ö†Ô∏è No hay token de autenticaci√≥n');
                showMessage('‚ö†Ô∏è Debes iniciar sesi√≥n para hacer una solicitud', true);
                setTimeout(() => {
                    window.location.href = 'LogIn.html';
                }, 2000);
                return;
            }

            // Llamar al nuevo endpoint /api/auth/me
            const response = await fetch('http://localhost:3000/api/auth/me', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            const data = await response.json();

            if (data.autenticado && data.Cedula) {
                console.log('‚úÖ Datos del usuario obtenidos:', data);

                // ‚≠ê Llenar el campo oculto de c√©dula
                document.getElementById('cedula').value = data.Cedula;

                // Prellenar otros campos autom√°ticamente
                if (data.Nombre) {
                    document.getElementById('nombre').value = data.Nombre;
                    document.getElementById('nombre').setAttribute('readonly', true);
                }
                if (data.Apellido) {
                    document.getElementById('apellido').value = data.Apellido;
                    document.getElementById('apellido').setAttribute('readonly', true);
                }
                if (data.IdGenero) {
                    const radioGenero = document.querySelector(`input[name="genero"][value="${data.IdGenero}"]`);
                    if (radioGenero) {
                        radioGenero.checked = true;
                        // Hacer readonly todos los radios de g√©nero
                        document.querySelectorAll('input[name="genero"]').forEach(radio => {
                            radio.setAttribute('disabled', true);
                        });
                    }
                }
                if (data.IdFacultad) {
                    document.getElementById('facultad').value = data.IdFacultad;
                    document.getElementById('facultad').setAttribute('disabled', true);
                }

                console.log('‚úÖ Campos del formulario prellenados con datos del usuario');

            } else {
                console.warn('‚ö†Ô∏è Usuario no autenticado o sin datos completos');
                showMessage('‚ö†Ô∏è Debes iniciar sesi√≥n para hacer una solicitud', true);
                setTimeout(() => {
                    window.location.href = 'LogIn.html';
                }, 2000);
            }

        } catch (error) {
            console.error('‚ùå Error al obtener datos del usuario:', error);
            showMessage('‚ùå Error al verificar sesi√≥n. Por favor, inicia sesi√≥n nuevamente.', true);

            setTimeout(() => {
                window.location.href = 'LogIn.html';
            }, 2000);
        }
    }

    // ‚≠ê Llamar a la funci√≥n al cargar la p√°gina
    cargarDatosSesion();

    // Leer par√°metros de la URL para preseleccionar programa
    const urlParams = new URLSearchParams(window.location.search);
    const tipoParam = urlParams.get('tipo');
    const programaParam = urlParams.get('programa');

    if (tipoParam) {
        const tipoProgramaSelect = document.getElementById('tipoPrograma');
        tipoProgramaSelect.value = tipoParam;
        tipoProgramaSelect.setAttribute('data-preselected', 'true');
        tipoProgramaSelect.dispatchEvent(new Event('change'));
    }

    if (programaParam) {
        setTimeout(() => {
            const programaSelect = document.getElementById('programa');
            programaSelect.value = programaParam;
            programaSelect.setAttribute('data-preselected', 'true');
        }, 100);
    }

    // Funci√≥n para mostrar mensajes
    function showMessage(message, isError = false) {
        messageDiv.style.display = 'block';
        messageDiv.textContent = message;
        messageDiv.style.backgroundColor = isError ? '#fee2e2' : '#dcfce7';
        messageDiv.style.color = isError ? '#dc2626' : '#16a34a';
        messageDiv.style.border = isError ? '1px solid #fca5a5' : '1px solid #86efac';
        messageDiv.classList.add('success-animation');
        
        setTimeout(() => {
            messageDiv.classList.remove('success-animation');
        }, 500);
    }
    
    // Funci√≥n para mostrar/ocultar loading
    function showLoading(show) {
        loadingDiv.style.display = show ? 'block' : 'none';
        loadingDiv.textContent = show ? 'üì§ Enviando solicitud...' : '';
    }
  
    // ‚≠ê ENV√çO DEL FORMULARIO CON C√âDULA AUTOM√ÅTICA
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        messageDiv.style.display = 'none';
        
        // ‚≠ê Verificar que la c√©dula est√© presente
        const cedula = document.getElementById('cedula').value;
        
        if (!cedula) {
            showMessage('‚ùå Error: No se pudo obtener tu c√©dula. Por favor, inicia sesi√≥n nuevamente.', true);
            return;
        }
        
        console.log('üìã C√©dula a enviar:', cedula);
        
        showLoading(true);

        const formData = new FormData(form);

        // Habilitar campos deshabilitados temporalmente para que se env√≠en
        const facultadSelect = document.getElementById('facultad');
        const wasDisabled = facultadSelect.disabled;
        if (wasDisabled) {
            facultadSelect.disabled = false;
            formData.set('facultad', facultadSelect.value);
        }

        // Verificar que la c√©dula est√© en el FormData
        console.log('üì§ Datos del formulario:');
        for (let [key, value] of formData.entries()) {
            console.log(`   ${key}: ${value}`);
        }

        // Restaurar estado disabled
        if (wasDisabled) {
            facultadSelect.disabled = true;
        }

        fetch('http://localhost:3000/api/formulario', {
            method: 'POST',
            body: formData,
            credentials: 'include' // Importante para mantener sesi√≥n
        })
        .then(response => response.json())
        .then(data => {
            showLoading(false);

            if (data.success) {
                showMessage(`‚úÖ ¬°Solicitud registrada exitosamente!
                             üìù ID: ${data.id}`, false);
                
                // Limpiar el formulario EXCEPTO la c√©dula (que est√° oculta)
                form.reset();
                
                // Re-llenar la c√©dula despu√©s del reset
                document.getElementById('cedula').value = cedula;
                
                messageDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
            } else {
                showMessage(`‚ùå ${data.error || 'Ocurri√≥ un error inesperado.'}`, true);
            }
        })
        .catch(error => {
            showLoading(false);
            showMessage('‚ùå Error al enviar la solicitud. Intenta nuevamente.', true);
            console.error('‚ùå Error en la petici√≥n:', error);
        });
    });

    // Funcionalidad para actualizar el select de programas seg√∫n el tipo
    const tipoProgramaSelect = document.getElementById('tipoPrograma');
    const programaSelect = document.getElementById('programa');
    
    tipoProgramaSelect.addEventListener('change', function() {
        const tipoSeleccionado = this.value;
        const opciones = programaSelect.querySelectorAll('option');
        
        programaSelect.value = '';
        
        opciones.forEach(option => {
            if (option.value === '') {
                option.style.display = 'block';
            } else {
                const tipoOpcion = option.getAttribute('data-tipo');
                if (tipoOpcion === tipoSeleccionado || !tipoSeleccionado) {
                    option.style.display = 'block';
                } else {
                    option.style.display = 'none';
                }
            }
        });
    });
});
</script>
</body>
</html>